# Author: Max Stoddard
name: Dashboard CI

on:
  pull_request:
    branches:
      - master
    paths:
      - dashboard/**
      - input-data-versions/**
      - .github/workflows/dashboard-ci.yml
  push:
    branches:
      - master
    paths:
      - dashboard/**
      - input-data-versions/**
      - .github/workflows/dashboard-ci.yml

concurrency:
  group: dashboard-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  dashboard-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: dashboard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Smoke tests
        run: npm run test:smoke

  render-deploy-fallback:
    runs-on: ubuntu-latest
    needs:
      - dashboard-checks
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    env:
      RENDER_STATIC_DEPLOY_HOOK: ${{ secrets.RENDER_STATIC_DEPLOY_HOOK }}
      RENDER_API_DEPLOY_HOOK: ${{ secrets.RENDER_API_DEPLOY_HOOK }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: classify
        name: Classify changed paths
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            CHANGED="$(git ls-tree -r --name-only "$AFTER")"
          else
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER")"
          fi

          printf '%s\n' "$CHANGED" > changed-paths.txt

          if grep -Eq '^(dashboard/src/|dashboard/shared/|dashboard/package\.json$|dashboard/package-lock\.json$|dashboard/vite\.config\.ts$|dashboard/index\.html$)' changed-paths.txt; then
            echo "static_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "static_changed=false" >> "$GITHUB_OUTPUT"
          fi

          if grep -Eq '^(dashboard/server/|dashboard/shared/|dashboard/package\.json$|dashboard/package-lock\.json$|input-data-versions/)' changed-paths.txt; then
            echo "api_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "api_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger Render static deploy hook
        if: steps.classify.outputs.static_changed == 'true' && env.RENDER_STATIC_DEPLOY_HOOK != ''
        run: curl --fail --silent --show-error -X POST "$RENDER_STATIC_DEPLOY_HOOK"

      - name: Trigger Render API deploy hook
        if: steps.classify.outputs.api_changed == 'true' && env.RENDER_API_DEPLOY_HOOK != ''
        run: curl --fail --silent --show-error -X POST "$RENDER_API_DEPLOY_HOOK"

      - name: Missing static deploy hook secret
        if: steps.classify.outputs.static_changed == 'true' && env.RENDER_STATIC_DEPLOY_HOOK == ''
        run: echo "RENDER_STATIC_DEPLOY_HOOK is not set; static fallback trigger skipped."

      - name: Missing API deploy hook secret
        if: steps.classify.outputs.api_changed == 'true' && env.RENDER_API_DEPLOY_HOOK == ''
        run: echo "RENDER_API_DEPLOY_HOOK is not set; API fallback trigger skipped."
